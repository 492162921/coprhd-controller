%{
nameDescTabID = 'nameDescContent';
uploadFileTabID = 'uploadFileContent';
inputOutputTabID = 'inputOutputContent';
}%

#{Modal.dialog id:'shellPrimitiveDialog', cssClass:'wide', titleKey:'shell.primitive.add.title'}
<div class="row">
    #{form @createShellScriptPrimitive(), id:'shellScriptPrimitiveForm', enctype:'multipart/form-data', class:'form form-horizontal',
    autocomplete:"off"}
    <input type="hidden" name="shellPrimitive.wfDirID" id="shellPrimitive_wfDirID"/>
    <div class="col-md-3 tabbable">
        <ul class="nav nav-pills nav-stacked">
            <li role="presentation" class="active"><a href="${'#'+nameDescTabID}" data-toggle="tab"><span class="badge">1</span>
                &{'primitive.menu.nameDescription'}</a></li>
            <li class=""><a href="${'#'+uploadFileTabID}" data-toggle="tab"><span class="badge">2</span>
                &{'primitive.menu.uploadFile'}</a>
            </li>
            <li class=""><a href="${'#'+inputOutputTabID}" data-toggle="tab"><span class="badge">3</span>
                &{'primitive.menu.inputsOuputs'}</a></li>
        </ul>
    </div>
    <div class="col-md-9">
        <div class="tab-content">
            <div class="tab-pane active" id="${nameDescTabID}">
                #{Modal.body}
                    #{field 'shellPrimitive.name'}
                        %{
                        field.cssClass = "span6 initialFocus"
                        field.required = true
                        }%
                        #{Form.inputTextControlGroup field:field /}
                    #{/field}

                    #{field 'shellPrimitive.description'}
                        #{Form.textAreaControlGroup field:field, rows:5 /}
                    #{/field}
                #{/Modal.body}

            </div>
            <div class="tab-pane" id="${uploadFileTabID}">
                #{Modal.body}
                    #{field 'shellPrimitive.script'}
                        %{
                        field.required = true
                        }%
                        #{Form.fileUploadControlGroup field:field/}
                    #{/field}
                    #{field 'shellPrimitive.scriptName'}
                        #{Form.inputTextControlGroup field:field /}
                    #{/field}
                #{/Modal.body}

            </div>
            <div class="tab-pane" id="${inputOutputTabID}">
                #{Modal.body}
                    <div>
                        <ul id="" class="nav nav-tabs" role="tablist">
                            <li class="active"><a href="#inputContent" role="tab" data-toggle="tab">&nbsp;&{'primitive.tabs.input'}</a>
                            </li>
                            <li><a href="#outputContent" role="tab" data-toggle="tab">&nbsp;&{'primitive.tabs.output'}</a>
                            </li>
                        </ul>
                        <div class="tab-content" ng-controller="shellPrimitiveController">
                            <div class="tab-pane active" id="inputContent" style="width: 300px;">
                                <!-- Input Tab -->
                                <div class="row" ng-repeat="info in scriptIOs.inputs" style="margin-bottom:5px;">
                                    <div class="pull-left col-sm-11" v-field="info.input">
                                        <input-text></input-text>
                                    </div>
                                    <div class="pull-left col-sm-1" style="padding-left:0px; margin-top:5px;">
                                        <button type="button" ng-click="deleteInput($index)" class="close">&times;</button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="pull-left col-sm-11">
                                        <button type="button" ng-click="addInput()" class="btn btn-sm btn-success"><i
                                                v-icon=plus></i> &{'button.add'}
                                        </button>
                                    </div>
                                </div>

                            </div>
                            <div class="tab-pane" id="outputContent" style="width: 300px;">
                                <!-- Output Tab -->
                                <div class="row" ng-repeat="info in scriptIOs.outputs" style="margin-bottom:5px;">
                                    <div class="pull-left col-sm-11" v-field="info.output">
                                        <input-text></input-text>
                                    </div>
                                    <div class="pull-left col-sm-1" style="padding-left:0px; margin-top:5px;">
                                        <button type="button" ng-click="deleteOutput($index)" class="close">&times;</button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="pull-left col-sm-11">
                                        <button type="button" ng-click="addOutput()" class="btn btn-sm btn-success"><i
                                                v-icon=plus></i> &{'button.add'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="shellPrimitive.inputs" ng-value="inputs"/>
                            <input type="hidden" name="shellPrimitive.outputs" ng-value="outputs"/>
                        </div>
                    </div>
                #{/Modal.body}

            </div>
        </div>

        #{Modal.footer}
        #{Form.button name:'button.back', id:'backButton', icon:'arrow-left'/}
        #{Form.button name:'button.next', id:'nextButton', class:'primary', icon:'arrow-right'/}
        #{Form.button name:'button.finish', id:'finishButton', class:'primary', icon:'check',
        submit:'shellScriptPrimitiveForm'/}
        #{Form.button name:'button.cancel', icon:'remove', data:['dismiss':'modal']/}
        #{/Modal.footer}
    </div>
    #{/form}
</div>
#{/Modal.dialog}

<script>
    function checkFinish() {
        var complete = true;
        if (isBlank($('#shellPrimitive_name').val())) {
            complete = false;
        }
        if (isBlank($('#shellPrimitive_script').val())) {
            complete = false;
        }

        // If form is complete, enable FINISH button
        if (complete) {
            $('#finishButton').prop('disabled', false);
        }
        else {
            $('#finishButton').prop('disabled', true);
        }
    }

    $('#shellPrimitiveDialog').on('shown.bs.modal', function () {
        // Setting selected workflow directory ID
        $('#shellPrimitive_wfDirID').val($('#jstree_demo').jstree(true).get_selected()[0]);

        //on start hiding finish and back buttons
        $('#finishButton').hide();
        $('#backButton').hide();

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var activeTabID = $(e.target).attr('href');
            if (activeTabID.indexOf("${nameDescTabID}") >=0 ) {
                $('#backButton').hide();
                $('#nextButton').show();
                $('#finishButton').hide();
            }
            else if (activeTabID.indexOf("${uploadFileTabID}") >=0 ) {
                $('#backButton').show();
                $('#nextButton').show();
                $('#finishButton').hide();
            }
            else if (activeTabID.indexOf("${inputOutputTabID}") >=0 ) {
                $('#backButton').show();
                $('#nextButton').hide();
                $('#finishButton').show();
                checkFinish();
            }
        })

        var $tabs = $('.tabbable li');
        $('#backButton').on('click', function() {
            var prevTabAnchor = $tabs.filter('.active').prev('li').find('a[data-toggle="tab"]');
            if(prevTabAnchor.length == 1) {
                prevTabAnchor.tab('show');
            }
            else if(prevTabAnchor.length == 0) {
                //if there is no previous tab, disable back button
                $('#backButton').prop("disabled",true);
            }
        });

        $('#nextButton').on('click', function() {
            $tabs.filter('.active').next('li').find('a[data-toggle="tab"]').tab('show');
        });
    });


    angular.module("portalApp").controller('shellPrimitiveController', function($element, $scope, $compile, $http) {
        $scope.scriptIOs = {};
        $scope.scriptIOs.inputs = [];

        $scope.addI = {input:''};
        //$scope.scriptInputs = [];
        $scope.deleteInput = function(idx) {
            $scope.scriptIOs.inputs.splice(idx, 1);
        }
        $scope.addInput = function() {
            $scope.scriptIOs.inputs.push(angular.copy($scope.addI));
        }

        $scope.scriptIOs.outputs = [];
        $scope.addO = {output:''};
        $scope.deleteOutput = function(idx) {
            $scope.scriptIOs.outputs.splice(idx, 1);
        }
        $scope.addOutput = function() {
            $scope.scriptIOs.outputs.push(angular.copy($scope.addO));
        }

        $scope.$watch('scriptIOs', function(newVal) {
            var inputs = [], outputs = [];
            angular.forEach($scope.scriptIOs.inputs, function(obj) {
                if (obj.input !== '') inputs.push(obj.input);
            });
            angular.forEach($scope.scriptIOs.outputs, function(obj) {
                if (obj.output !== '') outputs.push(obj.output);
            });

            $scope.inputs = inputs.toString();
            $scope.outputs = outputs.toString();
       }, true);

    });




</script>

