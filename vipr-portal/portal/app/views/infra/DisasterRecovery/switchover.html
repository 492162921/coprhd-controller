#{extends 'main.html'/}
#{set navSelected: ['nav.settings', 'nav.disasterRecovery'] /}
#{if iamPrimary }
	#{set 'title'}&{'disasterRecovery.switchover'}#{/set}
#{/if}
#{else}
	#{set 'title'}&{'disasterRecovery.failover'}#{/set}
#{/else}
#{Form.header titleKey:'disasterRecovery.title' /}
#{alerts/}

<div>
   	<b style="font-size:13px">&{'disasterRecovery.switchover.active'}:</b>
   	<span id="bourne-version">${active_name}</span><br/>
</div>
<br/>
<div>
   	<b style="font-size:13px">&{'disasterRecovery.switchover.standby'}:</b>
   	<span id="bourne-version">${standby_name}</span><br/>
</div>
<br/>
<br/>
#{if iamPrimary }
	#{Form.subheader titleKey:"disasterRecovery.switchover.subtitle" /}
#{/if}
#{else}
	#{Form.subheader titleKey:"disasterRecovery.failover.subtitile" /}
#{/else}
<br/>
<div id="switchdesc">
	<span> &{'disasterRecovery.switchover.setting'} <b style="font-size:13px">${standby_name}</b> &{'disasterRecovery.switchover.active.to'}
	 <b style="font-size:13px">${active_name}</b> &{'disasterRecovery.switchover.standby.to'}</span> <br/><br/>
	<dl>
  		<dt id="loadingStatus"> #{loading/}</dt>
  		#{if iamPrimary }
			<dd id="checkFailoverStatus">&{'disasterRecovery.switchover.progress'} </dd>
		#{/if}
		#{else}
			<dd id="checkFailoverStatus">&{'disasterRecovery.failover.progress'} </dd>
		#{/else}
	</dl>
	<span id="failoverWarining">&{'disasterRecovery.failover.progress.warning'}</span><br/><br/>
	<br/>
	<span id="redirectSite">
		&{'disasterRecovery.switchover.login.instruction'} <a href="https://${standby_vip}" >${standby_name}</a>
	</span>
</div>

<script>
$(document).ready(function() {
	checkFailoverStatusUpdates();
});

function checkFailoverStatusUpdates() {
	window.setInterval(function() {
		checkFailoverProgressUpdate()
    }, 10000); // Check every 10 seconds
}

var checkFailoverProgress = #{jsAction @checkFailoverProgress(':uuid')/};

function checkFailoverProgressUpdate() {
	$.ajax({
        method: "get",
        url: checkFailoverProgress(({"uuid": "${site_uuid}"})),
        dataType: "json",

        success: function(result) {
			if(result.state == "ACTIVE" || result.state == "STANDBY_SYNCED" ) {
				$("#loadingStatus").text('&{'disasterRecovery.failover.complete'}');
 				$("#checkFailoverStatus").text('');
 				$("#failoverWarining").text('');
			}
			if(result.state == "STANDBY_ERROR") {
				$("#loadingStatus").text('&{'disasterRecovery.failover.uncomplete'}');
				$("#checkFailoverStatus").text('');
				$("#failoverWarining").text('');
				$("#redirectSite").text('&{'disasterRecovery.switchover.failed.instruction'}');
			}
        },
        error: function() {
        }
	});
}
</script>