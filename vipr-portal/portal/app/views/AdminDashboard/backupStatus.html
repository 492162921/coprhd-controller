#{set isActiveSite:controllers.infra.DisasterRecovery.isActiveSite() /}
#{set isExternalServerConfigured:util.BackupUtils.isExternalServerConfigured() /}
#{set isScheduledBackupEnabled:util.BackupUtils.isScheduledBackupEnabled() /}

<div id="backupPanel">
    <div class="panel panel-default">
        <div class="panel-heading"><h3 class="panel-title">&{'adminDashboard.backupStatus'}</h3></div>
        <div class="panel-body">
        <table style="margin-top:0px;width:100%">
            <tbody>
            <tr class="odd ng-scope openRow">
                <td class="type" height="25px" width="170px">&{'adminDashboard.lastSuccessfulBackup'}: </td>
                <td class="icon" height="25px" width="25px">
                #{if backupOperationStatus?.getLastSuccessfulCreation()?.opStatus}
                    <span class="text-success">#{icon 'ok-sign'/}</span>
                #{/if}
                </td>
                <td class="time">
                    <a href="@{Backup.list()}" id="lastSuccessful"></a>
                </td>
            </tr>
            <script>
                var lastSuccessfulCreationTime = '${backupOperationStatus?.getLastSuccessfulCreation()?.opTime}';
                var lastSuccessfulBackupType = '${backupOperationStatus?.getLastSuccessfulCreation()?.opMessage}';
                if (lastSuccessfulCreationTime && lastSuccessfulBackupType) {
                    $('#lastSuccessful').append(formatLocalDateTime(new Date(lastSuccessfulCreationTime))).append(lastSuccessfulBackupType.toString());;
                } else {
                    $('#lastSuccessful').append("NA");
                }
            </script>

            <tr class="odd ng-scope openRow">
                <td class="type" height="25px" width="170px">&{'adminDashboard.lastManualBackup'}: </td>
                <td class="icon" height="25px" width="25px">
                    #{if backupOperationStatus?.getLastManualCreation()?.opStatus}
                        #{if 'success'.equalsIgnoreCase('${backupOperationStatus?.getLastManualCreation()?.opStatus}')}
                            <span class="text-success">#{icon 'ok-sign'/}</span>
                        #{/if}
                        #{else}
                            <span class="text-danger">#{icon 'remove-sign'/}</span>
                        #{/else}
                    #{/if}
                </td>
                <td class="time">
                    <a href="@{Backup.list()}" id="lastManual"></a>
                </td>
            </tr>
            <script>
                var lastManualCreationTime = '${backupOperationStatus?.getLastManualCreation()?.opTime}';
                if (lastManualCreationTime) {
                    $('#lastManual').append(formatLocalDateTime(new Date(lastManualCreationTime)));
                } else {
                    $('#lastManual').append("NA");
                }
            </script>

            <tr class="odd ng-scope openRow">
                <td class="type" height="25px" width="170px">&{'adminDashboard.lastScheduledBackup'}: </td>
                <td class="icon" height="25px" width="25px">
                    #{if backupOperationStatus?.getLastScheduledCreation()?.opStatus}
                        #{if 'success'.equalsIgnoreCase('${backupOperationStatus?.getLastScheduledCreation()?.opStatus}')}
                            <span class="text-success">#{icon 'ok-sign'/}</span>
                        #{/if}
                        #{else}
                            <span class="text-danger">#{icon 'remove-sign'/}</span>
                        #{/else}
                    #{/if}
                </td>
                <td class="time">
                    <a href="@{Backup.list()}" id="lastScheduled"></a>
                </td>
            </tr>
            <script>
                var lastScheduledCreationTime = '${backupOperationStatus?.getLastScheduledCreation()?.opTime}';
                if (lastScheduledCreationTime) {
                    $('#lastScheduled').append(formatLocalDateTime(new Date(lastScheduledCreationTime)));
                } else {
                    $('#lastScheduled').append("NA");
                }
            </script>

            <tr class="odd ng-scope openRow">
                <td class="type" height="25px" width="170px">&{'adminDashboard.nextScheduledBackup'}: </td>
                <td class="icon" height="25px" width="25px">
                #{if isScheduledBackupEnabled == false}
                    <span class="text-warning">#{icon 'warning-sign'/}</span>
                #{/if}
                </td>
                <td class="time" id="nextScheduled"></td>
            </tr>
            <script>
                if (isScheduledBackupEnabled) {
                    var nextScheduledCreationTime = '${backupOperationStatus?.getNextScheduledCreation()?.opTime}';
                    if (nextScheduledCreationTime) {
                        $('#nextScheduled').append(formatLocalDateTime(new Date(nextScheduledCreationTime)));
                    } else {
                        $('#nextScheduled').append("NA");
                    }
                } else {
                    $('#nextScheduled').append("Disabled");
                }
            </script>

            <tr class="odd ng-scope openRow">
                <td class="type" height="25px" width="170px">&{'adminDashboard.lastUploadStatus'}: </td>
                <td class="icon" height="25px" width="25px">
                #{if isExternalServerConfigured }
                    #{if backupOperationStatus?.getLastUpload()?.opStatus }
                        #{if 'true'.equalsIgnoreCase('${backupOperationStatus?.getLastUpload()?.opStatus}')}
                            <span class="text-success">#{icon 'ok-sign'/}</span>
                        #{/if}
                        #{else}
                            <span class="text-danger">#{icon 'remove-sign'/}</span>
                        #{/else}
                    #{/if}
                #{/if}
                #{else}
                    <span class="text-warning">#{icon 'warning-sign'/}</span>
                #{/else}
                </td>
                <td class="time">
                    #{if isExternalServerConfigured }
                    <a href="@{Backup.list()}" id="lastUpload"></a>
                    #{/if}
                    #{else}
                    <a href="@{Backup.list()}" id="externalServer"></a>
                    #{/else}
                </td>
            </tr>
            <script>
                if (isExternalServerConfigured == true) {
                    var lastUploadTime = '${backupOperationStatus?.getLastUpload()?.opTime}';
                    if (lastUploadTime) {
                        $('#lastUpload').append(formatLocalDateTime(new Date(lastUploadTime)));
                    } else {
                        $('#lastUpload').append("NA");
                    }
                } else {
                    $('#externalServer').append(&{'adminDashboard.lastUploadStatus.notConfigured'});
                }
            </script>
            </tbody>
        </table>
        </div>
    </div>
    #{if backupStatusLastUpdated}
    <div class="panel-footer">
        <small>&{'adminDashboard.lastUpdated'}
            <span data-format-relative-time="${backupStatusLastUpdated.getTime()}"></span>
        </small>
    </div>
    #{/if}
</div>
