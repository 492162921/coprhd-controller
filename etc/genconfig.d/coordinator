#!/etc/genconfig
#
# Copyright (c) 2015 EMC Corporation
# All Rights Reserved
#
# This software contains the intellectual property of EMC Corporation
# or is licensed to EMC Corporation from third parties.  Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of EMC.

_get_coordinator_var() {
    local var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_node_count"
    echo "--foreach:iter_primary:$(seq --separator=',' ${!var})"
    for i in $(seq ${!var}) ; do
        local var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_network_${i}_ipaddr"
        local var6="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_network_${i}_ipaddr6"
        local ipaddr="${!var}"
        [ -z "${ipaddr}" ] && ipaddr="[${!var6}]"
        echo "primary_${i}_ipaddr_service=${ipaddr}"
    done

    var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_standby_node_count"
    local standby_cnt="${!var}"
    if [ -n "${standby_cnt}" ]; then
        local primary_cnt="${_GENCONFIG_node_count}"
        echo "--foreach:iter_standby:$(seq --separator=',' $((${primary_cnt} + 1)) $((${primary_cnt} + ${standby_cnt})))"
        for standby_index in $(seq --separator=' ' $((${primary_cnt} + 1)) $((${primary_cnt} + ${standby_cnt}))); do
            var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_standby_network_$((${standby_index} - ${primary_cnt}))_ipaddr"
            var6="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_standby_network_$((${standby_index} - ${primary_cnt}))_ipaddr6"
            local ipaddr="${!var}"
            [ -z "${ipaddr}" ] && ipaddr="[${!var6}]"
            echo "standby_${standby_index}_ipaddr_service=${ipaddr}"
        done
    else
        echo "--foreach:iter_standby:"
    fi
    _get_props node_id node_index
}

_get_coordinator_jmx_props() {
    echo "network_ipaddr_service=${_GENCONFIG_network_ipaddr_service}"
}

_get_addrmap_props() {
    for index in ${_GENCONFIG_node_indexes}; do
        local var="_GENCONFIG_network_${index}_ipaddr"
        echo "network_${index}_ipaddr=${!var}"
        var="${var}6"
        echo "network_${index}_ipaddr6=${!var}"
    done
    _get_props node_id network_ipaddr network_ipaddr6
}

_get_coordinatorclient_var() {
    for i in ${_GENCONFIG_node_indexes} ; do
        local var="_GENCONFIG_network_${i}_ipaddr_service"
        echo "network_${i}_ipaddr_service=${!var}"
    done

    echo "node_count=${_GENCONFIG_node_count}"

    _get_props site_id
}

_genconfig_exec _gen_template_cluster   /opt/storageos/conf/coordinator-var.xml         $(_get_coordinator_var)
_genconfig_exec _gen_template           /opt/storageos/conf/coordinator-jmx-var.xml     $(_get_coordinator_jmx_props)
_genconfig_exec _gen_template_cluster   /opt/storageos/conf/nodeaddrmap-var.xml         $(_get_addrmap_props)
_genconfig_exec _gen_template_cluster   /opt/storageos/conf/coordinatorclient-var.xml   $(_get_coordinatorclient_var)
