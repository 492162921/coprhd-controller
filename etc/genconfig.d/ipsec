#!/etc/genconfig
#
# Copyright (c) 2015 EMC Corporation
# All Rights Reserved

PORTS_PROTECTED_IN_CLUSTER="tcp/2181 tcp/2888 tcp/2889 tcp/9160 tcp/7000 tcp/10099 tcp/40201"
PORTS_PROTECTED_ACROSS_SITE="tcp/2181 tcp/2888 tcp/2889 tcp/9160 tcp/7000"
IPSEC_CONF_FILE="/etc/ipsec.conf"
IPSEC_SECRET_FILE="/etc/ipsec.secrets"
DEFAULT_PRE_SHARED_KEY="defaultPreSharedKeyForIPSec"
FIRT_BOOT_FLAG_FILE="/.volumes/bootfs/etc/first_boot_flag"

# This method returns the configured ip address of this machine
_get_local_ip() {
    local nodeid="${_GENCONFIG_node_id}"
    local nodenum=${nodeid#vipr}
    local var="_GENCONFIG_network_${nodenum}_ipaddr"
    local var6="_GENCONFIG_network_${nodenum}_ipaddr6"
    local ipaddr="${!var}"
    [ -z "${ipaddr}" ] && ipaddr="[${!var6}]"
    echo "${ipaddr}"
}

# get ips in primary site
_get_ips_in_primary() {
    local cursite_begin_index="0"
    local var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_node_count"
    local primary_cnt="${!var}"
    local ips=""
    for i in $(seq ${primary_cnt}) ; do
        local var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_network_${i}_ipaddr"
        local var6="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_network_${i}_ipaddr6"
        local ipaddr="${!var}"
        [ -z "${ipaddr}" ] && ipaddr="[${!var6}]"
        ips="${ips} ${ipaddr}"
    done

    echo "${ips}"
}

# get ips in specified standby site
# input - standby site id
_get_ips_in_standby() {
    local standby=$1
    local ips=""

    if [ -n "${_GENCONFIG_site_ids}" ] ; then
        var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_${standby}_node_count"
        local standby_cnt="${!var}"
        for standby_index in $(seq 1 ${standby_cnt}); do
            var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_${standby}_network_${standby_index}_ipaddr"
            var6="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_${standby}_network_${standby_index}_ipaddr6"
            local ipaddr="${!var}"
            [ -z "${ipaddr}" ] && ipaddr="[${!var6}]"
            ips="${ips} ${ipaddr}"
        done
        begin="$((${begin} + ${standby_cnt}))"

    else
        # no standby defined
	    echo ""
    fi
    echo "$ips"
}


#
# common section for all connnections in ipsec.conf
#
LOCAL_IP=$(_get_local_ip)
COMMON_SECTION=$(cat << EOF
# common section for all connections
conn %default
    ikelifetime=60m
    keylife=20m
    rekeymargin=3m
    keyingtries=1
    keyexchange=ikev2
    authby=secret
    auto=route
    type=transport
    esp=aes128gcm16!
    left=${LOCAL_IP}
EOF
)

#
# section specific to each connection
#
_gen_conn_sections() {
    local ips=$1
    local ports=""
    if [[ ${ips} == *"${LOCAL_IP}"* ]] ; then
        ports=${PORTS_PROTECTED_IN_CLUSTER}
    else
        ports=${PORTS_PROTECTED_ACROSS_SITE}
    fi

    for ip in ${ips}
    do
        # skip generate connections for itself
        [ "${ip}" == "${LOCAL_IP}" ] && continue

        for port in ${ports}
        do
            conn=$(cat << EOF

conn ${LOCAL_IP}-${ip}-${port}
    right=${ip}
    rightprotoport=${port}
conn ${ip}-${LOCAL_IP}-${port}
    right=${ip}
    leftprotoport=${port}

EOF
)
    echo "${conn}"
        done
    done
}


_create_first_boot_flag_file() {
    /etc/systool --remount-rw
    local dir="$(dirname -- "${FIRT_BOOT_FLAG_FILE}")"
    [ -d "${dir}" ] || mkdir -p -- "${dir}"
    touch -- "${FIRT_BOOT_FLAG_FILE}"
    /etc/systool --remount-ro
}

#
# generate ipsec.conf and ipsec.secrets
#
_gen_ipsec_conf() {

    # based on flag file AND directory "/data/db/1" to determine if need to generate conf files
    #
    # flag file dose NOT exists: first boot, further check "data/db/1" directory existence
    #      - not exist: new installation, generate conf files
    #      - exist    : first boot after upgrade, do NOT generate conf files
    #
    # flag file exists: following up boots, further check ipsec_enabled flag 
    #      - true : generate files
    #      - false: do NOT generate files
    #
    local start_ipsec
    if [ -f "${FIRT_BOOT_FLAG_FILE}" ] ; then 
        if [ "${_GENCONFIG_ipsec_enabled}" == "false" ] ; then
            rm ${IPSEC_CONF_FILE} ${IPSEC_SECRET_FILE}
            start_ipsec=false	
	else
            start_ipsec=true		
	fi
    else
        _create_first_boot_flag_file

	if [ -d /data/db/1 ] ; then
            rm ${IPSEC_CONF_FILE} ${IPSEC_SECRET_FILE}
            start_ipsec=false	
	else
	    start_ipsec=true
	fi
    fi

    if [ "${start_ipsec}" = false ] ; then
	    return 0;
    fi

    # generating ipsec config files
    # generate common section and connections of primary site
    local ips_in_primary=$(_get_ips_in_primary)
    local connections_in_primary=$(_gen_conn_sections "${ips_in_primary}")
    local content=$(cat << EOF
${COMMON_SECTION}

# ips in primary site: ${ips_in_primary}
${connections_in_primary}
EOF
)

    if [ -n "${_GENCONFIG_site_ids}" ] ; then
        for standby in ${_GENCONFIG_site_ids} ; do
            local ips=$(_get_ips_in_standby "${standby}")
            connections_in_standby=$(_gen_conn_sections "${ips}")
            content=$(cat << EOF
${content}

# ips in ${standby} site: ${ips}
${connections_in_standby}
EOF
)
        done
    fi

    _genconfig_write 400 root:root "${IPSEC_CONF_FILE}" "${content}"
    _genconfig_write 400 root:root "${IPSEC_SECRET_FILE}" \
        " : PSK ${_GENCONFIG_ipsec_pre_shared_key:-${DEFAULT_PRE_SHARED_KEY}}"
}

_gen_ipsec_conf
