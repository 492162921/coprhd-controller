#!/etc/genconfig
#
# Copyright (c) 2015 EMC Corporation
# All Rights Reserved
#
# This software contains the intellectual property of EMC Corporation
# or is licensed to EMC Corporation from third parties.  Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of EMC.

PORTS_PROTECTED_IN_CLUSTER="tcp/2181 tcp/2888 tcp/2889"
PORTS_PROTECTED_ACROSS_SITE="tcp/2181 tcp/2888 tcp/2889"
IPSEC_CONF_FILE="/etc/ipsec.conf"
IPSEC_SECRET_FILE="/etc/ipsec.secrets"


# This method returns the configured ip address of this machine
_get_local_ip() {
    local nodeid="${_GENCONFIG_node_id}"
    local nodenum=${nodeid#vipr}
    local var="_GENCONFIG_network_${nodenum}_ipaddr"
    local var6="_GENCONFIG_network_${nodenum}_ipaddr6"
    local ipaddr="${!var}"
    [ -z "${ipaddr}" ] && ipaddr="[${!var6}]"
    echo "${ipaddr}"
}


_get_ips_in_cluster() {
    # generate participants for nodes in primary site 
    local cursite_begin_index="0"
    local var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_node_count"
    local primary_cnt="${!var}"
    local ips=""
    for i in $(seq ${primary_cnt}) ; do
        local var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_network_${i}_ipaddr"
        local var6="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_network_${i}_ipaddr6"
        local ipaddr="${!var}"
        [ -z "${ipaddr}" ] && ipaddr="[${!var6}]"
        if [ "${ipaddr}" != "${LOCAL_IP}" ] ; then
            ips="${ips} ${ipaddr}"
        fi
    done


    # add vip into ips
    local vip="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_network_vip"
    local vip6="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_network_vip6"
    local ipaddr="${!vip}"
    [ -z "${ipaddr}" ] && ipaddr="[${!vip6}]"
    if [ "${ipaddr}" != "${LOCAL_IP}" ] ; then
        ips="${ips} ${ipaddr}"
    fi


    echo "${ips}"
}

_get_ips_in_standby() {
    # generate observers for standby sites
    local ips=""
    if [ -n "${_GENCONFIG_site_ids}" ] ; then
        local begin="${primary_cnt}" # begin index in all node list
        local total="0"              # total number of all standby nodes
        for standby in ${_GENCONFIG_site_ids}; do
            var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_${standby}_node_count"
            local standby_cnt="${!var}"
            total="$((${standby_cnt} + ${total}))"
        done
       # echo "--foreach:iter_standby:$(seq --separator=',' $((${begin} + 1)) $((${begin} + ${total})) )"
        for standby in ${_GENCONFIG_site_ids} ; do
            if [ "${_GENCONFIG_site_myid}" == "${standby}" ] ; then
                cursite_begin_index="$((${begin}))"
            fi
            var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_${standby}_node_count"
            local standby_cnt="${!var}"
            for standby_index in $(seq --separator=',' $((${begin} + 1)) $((${begin} + ${standby_cnt}))); do
                var="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_${standby}_network_$((${standby_index} - ${begin}))_ipaddr"
                var6="_GENCONFIG_vdc_${_GENCONFIG_vdc_myid}_${standby}_network_$((${standby_index} - ${begin}))_ipaddr6"
                local ipaddr="${!var}"
                [ -z "${ipaddr}" ] && ipaddr="[${!var6}]"
                ips="${ips} ${ipaddr}"
            done
            begin="$((${begin} + ${standby_cnt}))"
        done
    else
        # no standby defined
	    echo ""
    fi
    echo "$ips"
}

LOCAL_IP=$(_get_local_ip)
IPS_IN_CLUSTER=$(_get_ips_in_cluster)
IPS_OF_STANDBYS=$(_get_ips_in_standby)

#
# common section for all connnections in ipsec.conf
#
COMMON_SECTION=$(cat << EOF

conn %default
    ikelifetime=60m
    keylife=20m
    rekeymargin=3m
    keyingtries=1
    keyexchange=ikev2
    authby=secret
    auto=route
    type=transport
    esp=aes128gcm16!
    left=${LOCAL_IP}

EOF
)

#
# section specific to each connection
#
_gen_conn_sections() {
    local ips=$1
    local ports=$2

    for ip in ${ips}
    do
        for port in ${ports}
        do
            conn=$(cat << EOF

conn ${LOCAL_IP}-${ip}-${port}
    right=${ip}
    rightprotoport=${port}

conn ${ip}-${LOCAL_IP}-${port}
    right=${ip}
    leftprotoport=${port}

EOF
)
    echo "${conn}"
        done
    done
}




#
# generate ipsec.conf and ipsec.secrets
#
_gen_ipsec_conf() {

    # based on ipsec_enabled to decide if need to generate ipsec config files
    if [ ${_GENCONFIG_ipsec_enabled} == "false" ] ; then
        rm ${IPSEC_CONF_FILE} ${IPSEC_SECRET_FILE}
        return
    fi

    # to do:
    #    check if it is the first boot after upgrade from previous non-ipsec cluster,
    #    if so, do not generate ipsec config files



    # ipsec_enabled = true, generating ipsec config files
    local conn_in_cluster=$(_gen_conn_sections "${IPS_IN_CLUSTER}" "${PORTS_PROTECTED_IN_CLUSTER}")
    local conn_of_standby=$(_gen_conn_sections "${IPS_OF_STANDBYS}" "${PORTS_PROTECTED_ACROSS_SITE}")
    local content=$(cat << EOF
# ips in cluster: ${IPS_IN_CLUSTER}
# ips in standby: ${IPS_OF_STANDBYS}
${COMMON_SECTION}
${conn_in_cluster}
${conn_of_standby}
EOF
)
    _genconfig_write 400 root:root "${IPSEC_CONF_FILE}" "${content}"
    _genconfig_write 400 root:root "${IPSEC_SECRET_FILE}" " : PSK ${_GENCONFIG_ipsec_pre_shared_key}"
}

_gen_ipsec_conf
