#!/etc/genconfig
#
# Copyright (c) 2016 EMC Corporation
# All Rights Reserved
#
# This software contains the intellectual property of EMC Corporation
# or is licensed to EMC Corporation from third parties.  Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of EMC.

_get_rabbitmq_props() {
    local cluster_nodes=""
    for i in ${_GENCONFIG_node_indexes} ; do
        if [ ${i} -ne ${_GENCONFIG_node_index} ] ; then 
            local name="_GENCONFIG_node_${i}_name"
            cluster_nodes=${cluster_nodes}rabbit@${!name}"," 
        fi
    done
    echo "rabbitmq_nodes=${cluster_nodes%?}"

}

_erlang_cookie() {
    echo "${_GENCONFIG_network_vip}" | sha1sum | awk '{print toupper($1)}'
}
_gen_erlang_cookie() { 
    _genconfig_write 400 root:root "${1}"     "$(_erlang_cookie)"
    _genconfig_done
}
_genconfig_exec _gen_template_cluster    /etc/rabbitmq/rabbitmq.config  $(_get_rabbitmq_props)
_genconfig_exec _gen_erlang_cookie /etc/rabbitmq/.erlang.cookie
